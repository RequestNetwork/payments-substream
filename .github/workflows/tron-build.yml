name: Tron Substreams Build

on:
  pull_request:
    branches:
      - main
    paths:
      - 'tron/**'
      - '.github/workflows/tron-build.yml'
  push:
    branches:
      - main
    paths:
      - 'tron/**'
      - '.github/workflows/tron-build.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      run_integration_tests:
        description: 'Run integration tests against live endpoint'
        required: false
        default: false
        type: boolean
      deploy_network:
        description: 'Deploy to network (none, nile, or mainnet)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - nile
          - mainnet

jobs:
  build-and-test:
    name: Build and Test Tron Substreams
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            tron/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('tron/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build WASM module
        working-directory: tron
        run: make build

      - name: Run unit tests
        working-directory: tron
        run: make test

      - name: Verify build artifacts
        working-directory: tron
        run: |
          echo "Checking build artifacts..."
          if [ ! -f "target/wasm32-unknown-unknown/release/request_network_tron.wasm" ]; then
            echo "ERROR: WASM file not found!"
            exit 1
          fi
          echo "Build artifacts verified successfully"

  integration-test:
    name: Integration Test (Live Endpoint)
    runs-on: ubuntu-latest
    needs: build-and-test
    # Run on: manual trigger, push to main, release, or when deploying
    # PRs only run unit tests (no API key needed)
    if: |
      github.event.inputs.run_integration_tests == 'true' ||
      (github.event.inputs.deploy_network != '' && github.event.inputs.deploy_network != 'none') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'release'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            tron/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('tron/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Substreams CLI
        run: |
          curl -sSL https://github.com/streamingfast/substreams/releases/latest/download/substreams_linux_x86_64.tar.gz | tar xz
          sudo mv substreams /usr/local/bin/
          substreams --version

      - name: Build WASM module
        working-directory: tron
        run: make build

      - name: Package Substreams
        working-directory: tron
        run: make package

      - name: Verify package created
        working-directory: tron
        run: |
          SPKG_FILE=$(ls -1 *.spkg 2>/dev/null | head -1)
          if [ -z "$SPKG_FILE" ]; then
            echo "ERROR: No .spkg package file found!"
            exit 1
          fi
          echo "✅ Package created: $SPKG_FILE"

      - name: Run integration test against Nile testnet
        working-directory: tron
        env:
          SUBSTREAMS_API_TOKEN: ${{ secrets.SUBSTREAMS_API_TOKEN }}
        run: |
          echo "=== Integration Test: Running substreams against TRON Nile testnet ==="
          echo "Block range: 63208782 to 63208882 (100 blocks from deployment)"
          echo ""
          
          SPKG_FILE=$(ls -1 *.spkg | head -1)
          echo "Using package: $SPKG_FILE"
          
          # Run substreams and capture JSON output
          # This tests the full pipeline: load WASM, connect to endpoint, process blocks, parse events
          # Note: substreams run exits with 0 on success, non-zero on failure
          if ! substreams run "$SPKG_FILE" map_erc20_fee_proxy_payments \
            -e tron.substreams.pinax.network:443 \
            --start-block 63208782 \
            --stop-block +100 \
            -o json 2>&1 | tee output.log; then
            echo ""
            echo "❌ FAILED: Substreams command returned non-zero exit code"
            echo "Output:"
            cat output.log
            exit 1
          fi
          
          echo ""
          echo "=== Validating Results ==="
          
          # If any payments were found, validate the structure
          if grep -q '"payments"' output.log; then
            echo "✅ Payments data structure detected in output"
            
            # Extract and validate payment fields if present
            if grep -q '"token_address"' output.log; then
              echo "✅ Payment fields present: token_address"
            fi
            if grep -q '"payment_reference"' output.log; then
              echo "✅ Payment fields present: payment_reference"
            fi
            if grep -q '"amount"' output.log; then
              echo "✅ Payment fields present: amount"
            fi
          else
            echo "ℹ️  No payments found in block range (expected if no transactions in these blocks)"
          fi
          
          echo ""
          echo "=== Integration Test PASSED ==="
          echo "The substreams module successfully:"
          echo "  - Loaded WASM module"
          echo "  - Connected to TRON Nile endpoint via Pinax"
          echo "  - Processed 100 blocks without errors"
          echo "  - Output valid JSON structure"

  deploy-testnet:
    name: Deploy to Nile Testnet
    runs-on: ubuntu-latest
    needs: [build-and-test, integration-test]
    # Deploy to testnet on: push to main, or manual with nile selected
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event.inputs.deploy_network == 'nile'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            tron/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('tron/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Substreams CLI
        run: |
          curl -sSL https://github.com/streamingfast/substreams/releases/latest/download/substreams_linux_x86_64.tar.gz | tar xz
          sudo mv substreams /usr/local/bin/

      - name: Install Graph CLI
        run: npm install -g @graphprotocol/graph-cli

      - name: Build WASM module
        working-directory: tron
        run: make build

      - name: Package Substreams
        working-directory: tron
        run: make package

      - name: Verify package created
        working-directory: tron
        run: |
          SPKG_FILE=$(ls -1 *.spkg 2>/dev/null | head -1)
          if [ -z "$SPKG_FILE" ]; then
            echo "ERROR: No .spkg package file found!"
            exit 1
          fi
          echo "Package created successfully: $SPKG_FILE"

      - name: Authenticate with The Graph Studio
        run: graph auth --studio ${{ secrets.GRAPH_STUDIO_DEPLOY_KEY }}

      - name: Deploy to Nile Testnet
        working-directory: tron
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          
          # Use commit SHA for testnet versions to track deployments
          VERSION_LABEL="v${VERSION}-${SHORT_SHA}"
          
          echo "Deploying to request-payments-tron-nile with version: $VERSION_LABEL"
          
          graph deploy --studio request-payments-tron-nile --version-label "$VERSION_LABEL"
          
          echo "✅ Deployed to Nile testnet"
          echo "Endpoint: https://api.studio.thegraph.com/query/67444/request-payments-tron-nile/version/latest"

  deploy-mainnet:
    name: Deploy to Mainnet
    runs-on: ubuntu-latest
    needs: [build-and-test, integration-test]
    # Deploy to mainnet on: GitHub release published, or manual with mainnet selected
    if: |
      github.event_name == 'release' ||
      github.event.inputs.deploy_network == 'mainnet'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            tron/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('tron/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Substreams CLI
        run: |
          curl -sSL https://github.com/streamingfast/substreams/releases/latest/download/substreams_linux_x86_64.tar.gz | tar xz
          sudo mv substreams /usr/local/bin/

      - name: Install Graph CLI
        run: npm install -g @graphprotocol/graph-cli

      - name: Build WASM module
        working-directory: tron
        run: make build

      - name: Package Substreams
        working-directory: tron
        run: make package

      - name: Verify package created
        working-directory: tron
        run: |
          SPKG_FILE=$(ls -1 *.spkg 2>/dev/null | head -1)
          if [ -z "$SPKG_FILE" ]; then
            echo "ERROR: No .spkg package file found!"
            exit 1
          fi
          echo "Package created successfully: $SPKG_FILE"

      - name: Authenticate with The Graph Studio
        run: graph auth --studio ${{ secrets.GRAPH_STUDIO_DEPLOY_KEY }}

      - name: Deploy to Mainnet
        working-directory: tron
        run: |
          # For releases, use the release tag as version
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
            VERSION="v${VERSION}"
          fi
          
          echo "Deploying to request-payments-tron with version: $VERSION"
          
          graph deploy --studio request-payments-tron --version-label "$VERSION"
          
          echo "✅ Deployed to Mainnet"
          echo "Endpoint: https://api.studio.thegraph.com/query/67444/request-payments-tron/version/latest"
