name: Tron Substreams Build

on:
  pull_request:
    branches:
      - main
    paths:
      - 'tron/**'
      - '.github/workflows/tron-build.yml'
  push:
    branches:
      - main
    paths:
      - 'tron/**'
      - '.github/workflows/tron-build.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      run_integration_tests:
        description: 'Run integration tests against live endpoint'
        required: false
        default: false
        type: boolean
      deploy_network:
        description: 'Deploy to network (none, nile, or mainnet)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - nile
          - mainnet

jobs:
  build-and-test:
    name: Build and Test Tron Substreams
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            tron/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('tron/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build WASM module
        working-directory: tron
        run: make build

      - name: Run unit tests
        working-directory: tron
        run: make test

      - name: Verify build artifacts
        working-directory: tron
        run: |
          echo "Checking build artifacts..."
          if [ ! -f "target/wasm32-unknown-unknown/release/request_network_tron.wasm" ]; then
            echo "ERROR: WASM file not found!"
            exit 1
          fi
          echo "Build artifacts verified successfully"

  integration-test:
    name: Integration Test (Live Endpoint)
    runs-on: ubuntu-latest
    needs: build-and-test
    # Run on: manual trigger with flag, push to main, or release
    if: |
      github.event.inputs.run_integration_tests == 'true' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'release'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            tron/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('tron/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Substreams CLI
        run: |
          curl -sSL https://github.com/streamingfast/substreams/releases/latest/download/substreams_linux_x86_64.tar.gz | tar xz
          sudo mv substreams /usr/local/bin/

      - name: Build WASM module
        working-directory: tron
        run: make build

      - name: Run integration test against Nile testnet
        working-directory: tron
        env:
          SUBSTREAMS_API_TOKEN: ${{ secrets.SUBSTREAMS_API_TOKEN }}
        run: |
          echo "Running substreams against Nile testnet (blocks 63208782-63208792)..."
          
          # Run against a small range of blocks to verify the module works
          substreams run ./substreams.yaml map_erc20_fee_proxy_payments \
            -e tron.substreams.pinax.network:443 \
            --start-block 63208782 \
            --stop-block +10 \
            --output json > output.json 2>&1 || true
          
          # Check that the run completed (even if no payments found)
          if grep -q "error" output.json; then
            echo "ERROR: Substreams run failed"
            cat output.json
            exit 1
          fi
          
          echo "Integration test completed successfully"
          cat output.json

  deploy-testnet:
    name: Deploy to Nile Testnet
    runs-on: ubuntu-latest
    needs: [build-and-test, integration-test]
    # Deploy to testnet on: push to main, or manual with nile selected
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event.inputs.deploy_network == 'nile'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            tron/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('tron/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Substreams CLI
        run: |
          curl -sSL https://github.com/streamingfast/substreams/releases/latest/download/substreams_linux_x86_64.tar.gz | tar xz
          sudo mv substreams /usr/local/bin/

      - name: Install Graph CLI
        run: npm install -g @graphprotocol/graph-cli

      - name: Build WASM module
        working-directory: tron
        run: make build

      - name: Package Substreams
        working-directory: tron
        run: make package

      - name: Verify package created
        working-directory: tron
        run: |
          SPKG_FILE=$(ls -1 *.spkg 2>/dev/null | head -1)
          if [ -z "$SPKG_FILE" ]; then
            echo "ERROR: No .spkg package file found!"
            exit 1
          fi
          echo "Package created successfully: $SPKG_FILE"

      - name: Authenticate with The Graph Studio
        run: graph auth --studio ${{ secrets.GRAPH_STUDIO_DEPLOY_KEY }}

      - name: Deploy to Nile Testnet
        working-directory: tron
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          
          # Use commit SHA for testnet versions to track deployments
          VERSION_LABEL="v${VERSION}-${SHORT_SHA}"
          
          echo "Deploying to request-payments-tron-nile with version: $VERSION_LABEL"
          
          graph deploy --studio request-payments-tron-nile --version-label "$VERSION_LABEL"
          
          echo "✅ Deployed to Nile testnet"
          echo "Endpoint: https://api.studio.thegraph.com/query/67444/request-payments-tron-nile/version/latest"

  deploy-mainnet:
    name: Deploy to Mainnet
    runs-on: ubuntu-latest
    needs: [build-and-test]
    # Deploy to mainnet on: GitHub release published, or manual with mainnet selected
    if: |
      github.event_name == 'release' ||
      github.event.inputs.deploy_network == 'mainnet'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            tron/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('tron/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Substreams CLI
        run: |
          curl -sSL https://github.com/streamingfast/substreams/releases/latest/download/substreams_linux_x86_64.tar.gz | tar xz
          sudo mv substreams /usr/local/bin/

      - name: Install Graph CLI
        run: npm install -g @graphprotocol/graph-cli

      - name: Build WASM module
        working-directory: tron
        run: make build

      - name: Package Substreams
        working-directory: tron
        run: make package

      - name: Verify package created
        working-directory: tron
        run: |
          SPKG_FILE=$(ls -1 *.spkg 2>/dev/null | head -1)
          if [ -z "$SPKG_FILE" ]; then
            echo "ERROR: No .spkg package file found!"
            exit 1
          fi
          echo "Package created successfully: $SPKG_FILE"

      - name: Authenticate with The Graph Studio
        run: graph auth --studio ${{ secrets.GRAPH_STUDIO_DEPLOY_KEY }}

      - name: Deploy to Mainnet
        working-directory: tron
        run: |
          # For releases, use the release tag as version
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
            VERSION="v${VERSION}"
          fi
          
          echo "Deploying to request-payments-tron with version: $VERSION"
          
          graph deploy --studio request-payments-tron --version-label "$VERSION"
          
          echo "✅ Deployed to Mainnet"
          echo "Endpoint: https://api.studio.thegraph.com/query/67444/request-payments-tron/version/latest"
